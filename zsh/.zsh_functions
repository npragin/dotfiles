mkcd() {
    if [ $# -eq 0 ]; then
        echo "Usage: mkcd <dir>..." >&2
        exit 1
    fi

    mkdir -p "$@" && cd "$1"
}

ac() {
    # Activates a local venv or conda environment
    # Usage: source ac [conda_env_name]

    # Supported virtual environment directory names
    VENV_DIRS=(".venv" "venv")

    if [ $# -eq 0 ]; then
        # No arguments - activate local venv
        venv_found=false
        for venv_dir in "${VENV_DIRS[@]}"; do
            if [ -f "$venv_dir/bin/activate" ]; then
                source "$venv_dir/bin/activate"
                venv_found=true
                break
            fi
        done
        
        if [ "$venv_found" = false ]; then
            echo "\033[1;31m❌ No venv found in current directory (checked: ${VENV_DIRS[*]})\033[0m" >&2
            return 1
        fi
    elif [ $# -eq 1 ]; then
        # An argument was provided - activate the specified conda environment
        conda activate "$@"
    else
        echo "Usage: ac [conda_env_name]" >&2
        return 1
    fi
}

deac() {
    # Deactivates the current virtual or conda environment
    # Usage: source deac [env_name]

    if [ $# -eq 1 ]; then
        # An argument was provided - validate it matches an active environment
        env_name="$1"
        venv_name=""
        conda_env=""

        if [[ -n "$VIRTUAL_ENV" ]]; then
            if [[ -f "$VIRTUAL_ENV/pyvenv.cfg" ]]; then
                venv_name="$(grep "^prompt = " "$VIRTUAL_ENV/pyvenv.cfg" | sed 's/^prompt = //')"
                # Fallback to venv dir name if prompt is not set
                if [[ -z "$venv_name" ]]; then
                    venv_name="$(basename "$VIRTUAL_ENV")"
                fi
            else
                echo "\033[1;31m❌ Error: '$VIRTUAL_ENV' is not a valid venv\033[0m" >&2
                return 1
            fi
        fi

        if [[ -n "$CONDA_DEFAULT_ENV" ]]; then
            conda_env="$CONDA_DEFAULT_ENV"
        fi

        # Check if the argument matches either environment
        if [[ "$env_name" == "$venv_name" ]]; then
            deactivate
        elif [[ "$env_name" == "$conda_env" ]]; then
            conda deactivate
        else
            echo "\033[1;31m❌ Error: '$env_name' does not match an active environment\033[0m" >&2
            return 1
        fi
    elif [ $# -eq 0 ]; then
        # No argument - deactivate whichever is active
        if [[ -n "$VIRTUAL_ENV" ]]; then
            deactivate
        elif [[ -n "$CONDA_DEFAULT_ENV" ]]; then
            conda deactivate
        else
            echo "\033[1;33m⚠️ Warning: No active environment to deactivate\033[0m" >&2
            return 1
        fi
    else
        echo "Usage: source deac [env_name]" >&2
        return 1
    fi
}

python() {
    if [ $# -eq 0 ] && [ -t 0 ]; then
        if command -v ipython >/dev/null 2>&1; then
            ipython
        else
            echo "\033[1;33m⚠️ Warning: ipython not found, falling back to python\033[0m" >&2
            command python
        fi
    else
        command python "$@"
    fi
}

python3() {
    if [ $# -eq 0 ] && [ -t 0 ]; then
        if command -v ipython >/dev/null 2>&1; then
            ipython
        else
            echo "\033[1;33m⚠️ Warning: ipython not found, falling back to python\033[0m" >&2
            command python3
        fi
    else
        command python3 "$@"
    fi
}

pip() {
    if [[ "$VIRTUAL_ENV" == "" ]] && [[ "$CONDA_DEFAULT_ENV" == "" ]]; then
        echo "\033[1;31m❌ ERROR: pip disabled outside conda/virtualenv\033[0m" >&2
        return 1
    fi
    command pip "$@"
}

pip3() {
    if [[ "$VIRTUAL_ENV" == "" ]] && [[ "$CONDA_DEFAULT_ENV" == "" ]]; then
        echo "\033[1;31m❌ ERROR: pip3 disabled outside conda/virtualenv\033[0m" >&2
        return 1
    fi
    command pip3 "$@"
}

brew() {
  command brew "$@"
  if [[ "$1" =~ ^(install|uninstall|remove)$ ]]; then
    if [[ -L ${XDG_CONFIG_HOME}/homebrew/Brewfile ]]; then
      brew bundle dump --file=${XDG_CONFIG_HOME}/homebrew/Brewfile --force --no-vscode
    else
      echo "\033[1;33m⚠️ Warning: ${XDG_CONFIG_HOME}/homebrew/Brewfile does not exist or is not a symlink - skipping auto-update.\033[0m" >&2
    fi
  fi
}
